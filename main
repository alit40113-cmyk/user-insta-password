import os, asyncio, json, datetime, re
from telethon import TelegramClient, events, Button
from telethon.sessions import StringSession
from telethon.tl.functions.channels import JoinChannelRequest
from telethon.tl.functions.messages import StartBotRequest

# --- [ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ] ---
API_ID = '39719802' 
API_HASH = '032a5697fcb9f3beeab8005d6601bde9'
MASTER_ID = 8504553407  # Ø¢ÙŠØ¯ÙŠÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
MASTER_TOKEN = '8331141429:AAGeDiqh7Wqk0fiOQMDNbPSGTuXztIP0SzA'

ACCS_FILE = 'accounts_data.json'
DB_FILE = 'master_db.json'

def load_db(file):
    if os.path.exists(file):
        with open(file, 'r') as f: return json.load(f)
    return {}

def save_db(file, data):
    with open(file, 'w') as f: json.dump(data, f)

# --- [ 1. Ù…Ø§ÙƒÙŠÙ†Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ ] ---
async def daily_gift_worker():
    while True:
        db = load_db(ACCS_FILE)
        for user_id, user_data in db.items():
            target_bot = user_data.get('target_bot', '@t06bot')
            for phone, info in user_data.get('accounts', {}).items():
                try:
                    client = TelegramClient(StringSession(info['ss']), API_ID, API_HASH)
                    await client.connect()
                    await client.send_message(target_bot, "/start")
                    await asyncio.sleep(3)
                    
                    # Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‚Ø³Ù… (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·) Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… (Ø§Ù„Ù‡Ø¯ÙŠØ©)
                    msgs = await client.get_messages(target_bot, limit=1)
                    if msgs[0].reply_markup:
                        # Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
                        for row in msgs[0].reply_markup.rows:
                            for btn in row.buttons:
                                if "Ø²ÙŠØ§Ø¯Ø©" in btn.text or "ØªØ¬Ù…ÙŠØ¹" in btn.text:
                                    await msgs[0].click(text=btn.text)
                                    await asyncio.sleep(2)
                                    break
                        
                        # Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                        new_msgs = await client.get_messages(target_bot, limit=1)
                        for row in new_msgs[0].reply_markup.rows:
                            for btn in row.buttons:
                                if "Ù‡Ø¯ÙŠØ©" in btn.text or "Ø§Ù„Ù‡Ø¯ÙŠØ©" in btn.text:
                                    await new_msgs[0].click(text=btn.text)
                                    db[user_id]['accounts'][phone]['balance'] += 1000 
                    await client.disconnect()
                except: continue
        save_db(ACCS_FILE, db)
        await asyncio.sleep(24 * 3600)

# --- [ 2. ÙˆØ¸ÙŠÙØ© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØªØ®Ø·ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ] ---
async def activate_and_join(ss, phone, bot_user, ref_id, owner_id):
    try:
        client = TelegramClient(StringSession(ss), API_ID, API_HASH)
        await client.connect()
        # ØªÙØ¹ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ù„Ù†Ù‚Ø§Ø· ØªØ±ÙˆØ­ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙƒØ¨Ù„)
        await client(StartBotRequest(bot=bot_user, referrer_id=int(owner_id), start_param=ref_id))
        await asyncio.sleep(2)
        
        # ØªØ®Ø·ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
        msg = await client.get_messages(bot_user, limit=1)
        if msg[0].reply_markup:
            for row in msg[0].reply_markup.rows:
                for b in row.buttons:
                    if b.url:
                        try: await client(JoinChannelRequest(b.url.split('/')[-1]))
                        except: pass
        await client.send_message(bot_user, "/start")
        await client.disconnect()
    except: pass

# --- [ 3. Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ] ---
bot = TelegramClient('master_session', API_ID, API_HASH).start(bot_token=MASTER_TOKEN)

@bot.on(events.NewMessage(pattern='/start'))
async def start(event):
    is_master = event.sender_id == MASTER_ID
    btns = [
        [Button.inline("â• Ø§Ø¶Ø§ÙÙ‡ Ø­Ø³Ø§Ø¨", data="add_acc"), Button.inline("â– Ù…Ø³Ø­ Ø­Ø³Ø§Ø¨", data="del_acc")],
        [Button.inline("ğŸ“² Ø§Ù„Ø§Ø±Ù‚Ø§Ù… Ø§Ù„Ø®Ø§ØµÙ‡ Ø¨Ùƒ", data="my_nums")],
        [Button.inline("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·)", data="start_farming")],
        [Button.inline("ğŸ“Š ÙØ­Øµ Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", data="check_points")],
        [Button.inline("ğŸ’° ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©", data="transfer_now")],
        [Button.url("Ø§Ù„Ù…Ø·ÙˆØ±", url="https://t.me/Alikhalafm")]
    ]
    if is_master:
        btns.append([Button.inline("ğŸ’ [Ø§Ù„Ù…Ø§Ù„Ùƒ] ØªÙ†ØµÙŠØ¨ Ù„Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯", data="deploy")])
    
    await event.reply("**Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø³ÙˆØ±Ø³ Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„**\n\n- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (10k) Ù…ÙØ¹Ù„.", buttons=btns)

@bot.on(events.CallbackQuery(data="start_farming"))
async def farming(event):
    uid = str(event.sender_id)
    db = load_json(ACCS_FILE)
    if uid not in db: return await event.answer("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø¶Ø§ÙØ©!", alert=True)

    async with bot.conversation(event.sender_id) as conv:
        await conv.send_message("ğŸ”— **Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù†Ù‡:**")
        link = (await conv.get_response()).text
        match = re.search(r"t\.me/([\w_]+)\?start=([\w\d]+)", link)
        if not match: return await conv.send_message("âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­.")
        
        bot_user, ref_id = match.group(1), match.group(2)
        db[uid]['target_bot'] = f"@{bot_user}"
        save_db(ACCS_FILE, db)

        await conv.send_message(f"ğŸš€ Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Ø±Ø§Ø¨Ø·Ùƒ ÙˆØªØ®Ø·ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...")
        for phone, info in db[uid]['accounts'].items():
            asyncio.create_task(activate_and_join(info['ss'], phone, bot_user, ref_id, event.sender_id))
            await asyncio.sleep(2)
        await conv.send_message("âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„. Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØµÙ„Øª Ù„Ø­Ø³Ø§Ø¨ÙƒØŒ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¯Ø£Øª ØªØ¬Ù…Ø¹ Ø§Ù„Ù‡Ø¯ÙŠØ© ÙŠÙˆÙ…ÙŠØ§Ù‹.")

@bot.on(events.CallbackQuery(data="transfer_now"))
async def transfer(event):
    uid = str(event.sender_id)
    db = load_db(ACCS_FILE)
    limit = 10000  # Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ­ÙˆÙŠÙ„
    target_bot = db.get(uid, {}).get('target_bot', '@t06bot')
    
    await event.answer("â³ Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙˆØ§ØµÙ„Ø© Ù„Ù€ 10,000 Ù†Ù‚Ø·Ø©...", alert=False)
    for phone, info in db.get(uid, {}).get('accounts', {}).items():
        if info.get('balance', 0) >= limit:
            try:
                client = TelegramClient(StringSession(info['ss']), API_ID, API_HASH)
                await client.connect()
                await client.send_message(target_bot, f"Ù†Ù‚Ù„ {event.sender_id} ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·")
                db[uid]['accounts'][phone]['balance'] = 0 # ØªØµÙÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                await client.disconnect()
            except: continue
    save_db(ACCS_FILE, db)
    await event.respond("âœ… Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ù‡Ù„Ø©.")

# --- [ Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„Ø³ÙˆØ±Ø³ ] ---
if __name__ == '__main__':
    print("ğŸš€ Ø§Ù„Ø³ÙˆØ±Ø³ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨ÙƒØ§Ù…Ù„ Ø·Ø§Ù‚ØªÙ‡...")
    loop = asyncio.get_event_loop()
    loop.create_task(auto_gift_worker())
    bot.run_until_disconnected()
